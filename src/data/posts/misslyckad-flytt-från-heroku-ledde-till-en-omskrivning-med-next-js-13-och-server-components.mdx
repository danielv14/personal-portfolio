---
title: Misslyckad flytt fr√•n Heroku ledde till en omskrivning med Next.js 13 och Server Components
summary: Jag f√∂rs√∂kte f√∂r ett tag sen flytta en gammal Nuxt applikation (som snart skulle sl√§ckas ned) fr√•n Heroku men ist√§llet blev det en ny sajt med annan hosting
description: Heroku st√§nger ned sin "free-plan" och jag beh√∂vde flytta en sajt jag hade d√§r. F√∂rs√∂kte flytta till Vercel ist√§llet men gr√§set var gr√∂nare p√• andra sidan med Next.js 13 och Server Components ist√§llet.
date: 2022-11-13
---

Heroku var valt att [sluta med gratis hosting](https://blog.heroku.com/next-chapter). Jag som m√•nga andra har en del sajter som snurrar d√§r med deras "free plan". I slutet p√• november 2022 kommer dessa sajter sl√§ckas ned. Jag, som s√• m√•nga andra, st√•r inf√∂r valet att l√•ta mina sajter som √§r hostade d√§r d√∂ eller f√∂rs√∂ka flytta dom till ett annat hem.

Jag f√∂rs√∂kte i f√∂rsta hand flytta den sajt som jag k√§nde var viktigast. Jag f√∂rs√∂kte flytta den till Vercel men efter f√∂r mycket problem l√§ngs v√§gen kom jag fram till: Jag skiter i att flytta den gamla sajten och **bygger en ny version med Next.js v13 som sl√§pptes nyss!** Varf√∂r d√•? Jo f√∂r att denna version introducerar <FunText>React server components</FunText> vilket man g√§rna vill prova p√•!

> Sajten i fr√•ga som jag f√∂rs√∂kte flytta √§r en sajt som anv√§nder Unsplash API f√∂r att hitta intressanta f√§rgpalletter fr√•n bilders dominanta f√§rger.

## Misslyckad flytt fr√•n Heroku till Vercel

Jag f√∂rs√∂kte allts√• i f√∂rsta hand att flytta hostingen av sajten till Vercel. Till en b√∂rjan gick det bra och det tog inte l√•ng tid f√∂rr√§n repot var ihopkopplat med Vercel och `git push` innebar att kod pushades till Vercel.

D√§r jag dock st√∂tte p√• mycket patrull var p√• grund av den custom express server som jag anv√§nde tillsammans med Nuxt samt den serverless arkitektur som Vercel f√∂rv√§ntade sig. F√∂r att f√• det hela att fungera s√• skulle en n√•got st√∂rre refaktorering beh√∂va ske p√• serversidan i min applikation. I en ren JavaScript-kodbas dessutom. Det hade jag ingen lust med.

Efter ett tag ins√•g jag att det vore b√§st att strunta i att f√∂rs√∂ka porta den gamla sajten och ist√§llet se detta som ett tillf√§lle att doppa t√•rna i Next.js v13 som sl√§pptes nyss. Som dessutom inneb√§r r√§tt stora f√∂r√§ndringar.

## Ny version med Next.js

Varf√∂r var jag d√• sugen p√• att testa senaste versionen av Next.js? <FunText>REACT SERVER COMPONENTS</FunText>.

N√§ men [h√§r kan man l√§sa](https://nextjs.org/blog/next-13) om nyheterna i den h√§r versionen. Det var allts√• framf√∂rallt introduceringen av `/app` foldern som bygger p√• server components som jag var sugen p√• att testa.

V√§rt att p√•peka √§r att i skrivande stund √§r `/app` foldern i beta och dokumetationen √§r √§nnu inte komplett.

## Server components

Att anv√§nda server components var f√∂rst r√§tt konstigt. Man √§r ju van sedan tidigare att anv√§nda bland annat `getStaticProps` och `getServerSideProps` n√§r man jobbar med Next.js, eller kanske `react-query` f√∂r datah√§mtning i en React SPA.

Det var s√•ledes r√§tt skumt att skriva kod som detta:

```tsx:app/page.tsx {1, 7} showLineNumbers
const getData = async () => {
  const data = await db.getData();
  return data;
};

const Page = async () => {
  const data = await getData();
  return <p>{data.name}</p>;
};

export default page;
```

Kodexemplet ovan √§r lite f√∂renklat men visar √§nd√• hur en server component kan vara uppbyggd. Inga API-anrop g√∂rs utan en komponent anropar en funktion som _direkt_ pratar med en databas ü§Ø. Funktionen `getData()` p√• rad ett beh√∂vs inte heller egentligen som "mellanhand".

> Det intressanta med Server components √§r dessutom att en komponent mycket l√§ngre ned i React-tr√§det kan h√§mta data p√• liknande s√§tt direkt, ist√§llet f√∂r att en `container` komponent eller liknande beh√∂ver vara inblandad. Eller att props drillas fr√•n `getServerSide` props. Man h√§mtar helt enkelt data i den komponent d√§r det beh√∂vs.

Koden i min Next.js 13 applikation vart s√•ledes r√§tt simpel. Inga API-endpoints beh√∂vdes. Jag hade bara en server component som anropade ett Unsplash API direkt och det hela server renderades automagiskt.

## Enklare kod

P√• tal om att inga API-anrop g√∂rs. Detta ledde till v√§ldigt enkel och straight-forward kod √∂verlag.

Sajten har en s√∂ksida p√• `/search` som tar emot tv√• stycken queryparametrar:

1. `query` - det man s√∂ker efter
2. `page` - klassisk paginering

S√∂ksidan f√∂rv√§ntas allts√• ha denna url-struktur: `/search?query=cats&page=2`. Hur hanterar man detta d√• i kontexten av React server components d√§r inga API-anrop g√∂rs eller inga n√§tverksanrop √∂verlag fr√•n browsern? Gamla hederliga `<form />` s√•klart

### S√∂kf√§lt

Sj√§lva s√∂kf√§ltet, som bygger `?query=[QUERY]` str√§ngen √§r helt enkelt ett vanligt `<form>` element med en `<input />`, helt fritt fr√•n `event.preventDefault()` eller `<form onSubmit={submitForm} />` hantering. S√∂kf√§ltet √§r ist√§llet uppbyggt s√•h√§r:

```tsx:app/Searchbar.tsx {1,8,10,20} showLineNumbers
"use client";

import { useSearchParams } from "next/navigation";
import { useState } from "react";

export const Searchbar = () => {
  const searchParams = useSearchParams();
  const [query, setQuery] = useState(searchParams.get("query") ?? "");
  return (
    <form action={`/search`} method="get">
      <div>
        <input
          required
          type="text"
          onChange={(e) => {
            setQuery(e.target.value);
          }}
          value={query}
          placeholder="Search for kittens, dogs or whatever"
          name="query"
        />
      </div>
    </form>
  );
};
```

N√•gra detaljer som √§r highlight:ade:

1. P√• rad 1 anv√§nds `use-client` vilket s√§ger √•t Next att detta √§r en komponent som ska klient-renderas, √§ven om den ligger i `/app` foldern som per default behandlar komponenter som Server komponenter. Detta g√∂rs f√∂r att kunna anv√§nda hooks s√•som `useSearchParams` och `useState`.

2. P√• rad 8 anv√§nds `useState` som s√§tter en s√∂kstr√§ng, med default v√§rde utifr√•n `searchParams`. Observera att `useState` och `onChange` p√• input-f√§ltet bara √§r till f√∂r att ge input-f√§ltet ett `value`.

3. P√• rad 10 s√§tts `action` och `method` p√• formul√§ret. Ingen specialare med `onSubmit` och `event.preventDefault()` g√∂rs.

4. P√• rad 20 s√§tts `name="query"` p√• input-f√§ltet och det kommer ju d√• inneb√§ra att n√§r fomul√§ret submittas s√• kommer v√§rdet fr√•n input-f√§ltet att √•ka med som query-parameter `?query=[INPUT_VALUE]`

### Paginering

Paginering av s√∂kresultat √§r i princip lika enkelt som sj√§lva formul√§ret f√∂r s√∂kf√§ltet:

```tsx app/PrevNextPage.tsx {13-15, 20-22} showLineNumbers
'use client';

import { useSearchParams } from 'next/navigation';

export const PrevNextPage = () => {
  const searchParams = useSearchParams();
  const currentPage = searchParams.has('page') ? parseInt(searchParams.get('page')!) : 0;
  const nextpage = searchParams.has('page') ? currentPage + 1 : 2;
  const prevPage = currentPage - 1;

  return (
    <div>
      <form action="/search" method="get">
        <input readOnly type="text" name="query" value={searchParams.get('query')} hidden />
        <input readOnly type="text" name="page" value={prevPage} hidden />
        <button disabled={prevPage < 1} type="submit">
          Previous page
        </button>
      </form>
      <form action="/search" method="get">
        <input readOnly type="text" name="query" value={searchParams.get('query')} hidden />
        <input readOnly type="text" name="page" value={nextpage} hidden />
        <button disabled={hasNoMoreContent} type="submit">
          Next page
        </button>
      </form>
    </div>
  );
};
```

N√•gra n√§mnv√§rda detaljer med den h√§r komponenten:

1. D√• paginering antingen kan g√• till **n√§sta** eller **f√∂reg√•ende sida** s√• beh√∂vs tv√• stycken formul√§r. Jag f√∂rs√∂kte f√∂rst trixa med ett och anv√§nda en massa logik men bland trumfar enkelheten.
2. F√∂r att f√• till `?page=` som query parameter och samtidigt beh√•lla `?query=` s√∂kfr√•gan s√• anv√§nder formul√§ren tv√• stycken input-f√§lt som √§r b√•de `readOnly` och `hidden`

## Tailwind

Jag ville passa p√• att sl√• tv√• flugor i en sm√§ll n√§r det g√§llde det h√§r projektet:

1. Testa Next.js v.13
2. Doppa t√•rna mer i **Tailwind**

Till ett s√•nt h√§r enkelt projekt tycker jag att Tailwind passade perfekt (√§ven om Tailwind f√∂rmodligen fungerar lika bra till projekt av st√∂rre skala).

Men f√∂r min del s√•g jag en rad f√∂rdelar:

<EmojiList as="ol">
  <EmojiList.Item emoji="üéâ">
    Tailwind kommer med r√§tt bra defaultv√§rden f√∂r paddings, f√§rger, font-storlekar osv.
  </EmojiList.Item>
  <EmojiList.Item emoji="ü§∑‚Äç‚ôÇÔ∏è">
    Man beh√∂ver inte bry sig om att namnge css klasser, skapa separata `StyledX` komponenter med n√•gon `CSS-in-JS`
    l√∂sning. Man beh√∂ver inte ens bry sig om separata css-filer och importera css-modules.
  </EmojiList.Item>
  <EmojiList.Item emoji="üåì">
    Support f√∂r light / darkmode utifr√•n en enhets systeminst√§llningar √§r sjukt enkelt.
  </EmojiList.Item>
</EmojiList>

F√∂r ett litet tag sedan blev [Tailwind CSS det mest nedladdade CSS-ramverket](https://twitter.com/adamwathan/status/1590877529141051392) p√• npm dessutom. S√• det var dags att se what the fuzz is about s√• att s√§ga.

## What about Next.js 13 d√•?

Ja s√• h√§r p√• andra sidan av projektet s√• m√•ste jag √§nd√• s√§ga att det var r√§tt intressant att labba med React server components, √§ven om det var r√§tt f√∂rvirrande i b√∂rjan.

Man fick liksom f√∂rs√∂ka l√§ra av sig att grejer som man vanligtvis g√∂r en React SPA:er eller liknande. Inga `useEffect` n√∂dv√§ndigtvis f√∂r att h√§mta data, inga `event.preventDefault()` i formul√§r i on√∂dan. Inte heller beh√∂ver man n√∂dv√§dnigsvis skapa endpoints serverside som React-komponenterna kan sl√• mot.

Det var helt klart intressant att utforska `/app` foldern s√• h√§r f√∂r f√∂rsta g√•ngen och f√∂rmodligen √§r det inte heller den sista d√• React-v√§rlden, eller webb-v√§rlden √∂verlag, verkar pendla fr√•n SPA:er till server-renderingen igen.

F√∂r den som √§r intresserad finns repot att [kika p√• h√§r](https://github.com/danielv14/Pic-Palette) och sajten att [bes√∂ka h√§r](https://pic-palette.vercel.app/)
