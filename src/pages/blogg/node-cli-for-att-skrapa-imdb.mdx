---
layout: blogPost
title: Node-baserat CLI f칬r att skrapa IMDb
summary: Enkelt CLI f칬r att f친 tag i viss information fr친n IMDb genom att skrapa sajten.
date: 2017-09-01
---


F칬r ett tag sedan stod jag inf칬r en uppgift som delvis gick ut p친 att anv칛nda filmer och tv-seriers IMDb ID:n. Att manuellt s칬ka upp filmer i webbl칛saren och kopiera ID:n fr친n URLen vart fort tradigt... Node-baserat CLI to the rescue!

F칬r den som inte vet vad ett IMDb ID 칛r s친 칛r det kortfattat ett unikt identifieringsnummer f칬r varje film, tv-serie, sk친despelarare och s친 vidare. Dessa id:n anv칛nds bland annat i URLen p친 f칬ljande s칛tt: `http://www.imdb.com/title/tt0411008/`. Str칛ngen som b칬rjar p친 **"tt"** 칛r sj칛vla id:t. Just **tt0411008** 칛r id:t f칬r tv-serien Lost f칬r 칬vrigt.

Jag beh칬vde allts친 p친 ett smidigt s칛tt komma 친t just de h칛r numren och efter att ha gjort manuella s칬kningar p친 IMDbs hemsida ett ex antal g친nger, klickat mig in p친 r칛tt s칬kresultat och kopierat id:t fr친n URLen s친 k칛ndes hela den processen v칛ldigt tradig. Dags att effektivisera!

Det h칛r var dessutom ett utm칛rkt tillf칛lle att skapa ett Node-baserat CLI och l칛ra mig lite mer om det d친 jag inte skapat s친 m친nga s친dana f칬rut men 칛r sedan tidigare relativt bekv칛m med Node och Javascript. Inte heller hade jag tidigare anv칛nt skrapning speciellt mycket med Javascrip.

## Vad beh칬ver CLI:t 친tstakomma?
Innan jag ens gjorde `git init` funderade jag 칬ver hur jag ville att mitt CLI skulle fungera, vad det skulle spotta ut f칬r information och b칬rjade fundera p친 vilka npm-paket som skulle kunna underl칛tta och g칬ra CLI:t b칛ttre. 

Min tanke var att CLI:t f칬rst skulle fr친ga anv칛ndaren efter en s칬kstr칛ng att s칬ka efter, g칬ra en request till IMDb:s hemsida och s칬kresultat, skrapa den information som beh칬vdes och spotta ut det i terminalen p친 ett 칬versk친dligt s칛tt. Jag t칛nkte mig att det fr칛mst handla om att skrapa fram titlar, 친rtal och sj칛lvfallet IMDb ID:n.

### Struktur
D친 jag i ett slags version 1.0.0 av CLI:t endast beh칬ver ett enkelt s칛tt att komma 친t IMDb ID:n skulle man lika g칛rna kunna skriva all kod i en och samma **index.js** fil. Men ska CLI:t l칛ngre fram kunna g칬ra mer saker blir det lite sv친rt att skala projektet och bygga vidare p친 det s친 d칛rf칬r valde jag att dela upp CLI:t i tv친 olika klasser och en **index.js**. Klasserna som skapades var en IMDb klass och en klass `queryHelper` f칬r att genomf칬ra lite manipulering av str칛ngar. 

### NPM-paket
Jag anv칛de mig av f칬ljande npm-paket f칬r att skapa mitt CLI:

* [Chalk](https://www.npmjs.com/package/chalk) - F칬r att s칛tta lite f칛rg p친 bland annat `console.log`.
* [Request](https://www.npmjs.com/package/request) - Ett enkelt s칛tt att g칬ra http requests.
* [Cheerio](https://www.npmjs.com/package/cheerio) - F칬r att skrapa IMDbs hemsida med en jQuery-liknande syntax.
* [Clear](https://www.npmjs.com/package/clear) - Ett paket vars enkla uppgift 칛r att rensa terminalf칬nstret.
* [Figlet](https://www.npmjs.com/package/figlet) - Ett paket f칬r att enkelt skapa ascii-konst av text. CLI:t m친ste ju vara lite snyggt ocks친.
* [Inquirer](https://www.npmjs.com/package/inquirer) - Anv칛ndes f칬r att fr친ga anv칛ndaren om s칬kstr칛ng och validera svaret.
* [Ora](https://www.npmjs.com/package/ora) - Ett paket f칬r att ge anv칛ndaren lite feedback i form av en spinner undertiden som IMDb skrapas och s칬kresultatet samlas in.
* [Table-master](https://www.npmjs.com/package/table-master) - Anv칛ndes f칬r att visa upp s칬kresultatet i en tabell.


## Genomf칬rande
Hur bygger man d친 ett Node-baserat CLI f칬r att skrapa IMDb:s hemsida och visa upp resultatet? Jag t칛nkte h칛r g친 igenom steg f칬r steg hur det skulle kunna se ut, f칬rhoppningsvis utan att g친 in i f칬r noga detalj om allt. 


Starta projektet med en `npm init` f칬r att skapa generera en **package.json** f칬ljt av en `git init`. Varf칬r inte anv칛nda git liksom?

Installera d칛refter alla npm-paket som kommer att anv칛ndas:

```bash
$ npm install --save chalk request cheerio clear figlet inquirer ora table-master
```

 Skapa d칛refter en **index.js** fil som agerar sj칛lva utg친ngspunkten f칬r CLI:t. De enda npm-paket som beh칬vs i just denna fil 칛r `clear` och `inquirer` d친 de 칬vriga paketen fr칛mst kommer anv칛ndas i ett senare skeda av IMDb klassen.
 
F칬ljande kod finns i min **index.js**:

```javascript:index.js
const clear = require('clear');
const inquirer = require('inquirer');

const inputError = 'Please enter a query to search for...';

// setup of question
const question = [
  {
    type: 'input',
    name: 'searchString',
    message: 'What do you want to search for?\n',
    validate: (value) => value.length ? true : inputError
  }
]

// clear the terminal window
clear();

// display colorful IMDb header
IMDb.displayHeader();

// prompt the user for a search string
inquirer.prompt(question).then((answer) => {
  let query = new queryHelper(answer.searchString);
  let result = new IMDb(query.getSanitizedQuery(), answer.searchString);
  result.scrape();  
})

```
F칬rst och fr칛mst anv칛nds `require` f칬r att f친 in de npm-paket som anv칛nds av filen, men 칛ven importeras de tv친 klasserna som 칛n s친 l칛nge inte finns. 

`const question = [...]` deklarerar en fr친ga med en tillh칬rande validering. Om inte valideringen g친r igenom s친 skrivs `inputError` str칛ngen ut i terminalen. 

D칛refter rensas terminalf칬nstret p친 samma s칛tt som att sj칛lv skriva `clear` i terminalen.
Sedan kallas en statisk metod fr친n IMDb klassen som av sitt namn kanske avsl칬jar vad den g칬r, men mer om metoden n칛r jag g친r igenom min IMDb klass.

L칛ngst ner i filen skapas sj칛lva prompten med hj칛lp av `inquirer` d칛r den tidigare question-arrayen skickas in och ett svar ges i ett promise.    
Inuti detta promise skapas f칬rst en ny instans av `queryHelper` klassen och en instans av IMDb klassen skapas med hj칛lp av en tv친 parametrar:

1. Den f칬rsta parametern `query.getSanitizedQuer()` g친r ut p친 omvandla en str칛ng fr친n "Harry Potter" till "Harry+Potter" d친 det formatet beh칬vs senare n칛r IMDbs webbplats skrapas.
2. Den andra parametern `answer.searchString` 칛r s칬kstr칛ngen som anv칛ndaren matar in i or칬rd form, det vill s칛ga exmpelvis "Harry Potter". Varf칬r det 칛r intressant att h친lla kvar i originals칬kstr칛ngen kommer visa sig i sj칛lva IMDb klassen. 

Men innan vi g친r igenom sj칛lva IMDb klassen d칛r sj칛lva tyngdlyften i det h칛r CLI:t h칛nder g친r vi igenom queryHelper klassen d친 den (i alla fall f칬r version 1.0.0) 칛r relativt liten.

```javascript{7,8,9,11,12,13}:queryHelper.js
exports.queryHelper = class {
  /**
   * Creates an instance of queryHelper.
   * @param {string} initialQuery 
   * @memberof queryHelper
   */
  constructor(initialQuery) {
    this.query = initialQuery;
  }
   /**
    * returns the query but sanitized 
    * replace all spaces with pluses
    * @returns {string}
    */
  getSanitizedQuery() {
    return this.query.replace(/ /g, '+');
  }
  /**
   * Match IMDb ID's from hrefs
   * 
   * @static
   * @param {string} href 
   * @returns {string} containing IMDb ID
   */
  static getIMDbID(href) {
    return href.match(/tt(.*)[0-9]/g).toString();
  }
}
```

Klassen best친r allts친 av en konstruktor och tv친 metoder. Den f칬rsta metoden `getSanitizedQuery()` returnerar en s칬kstr칛ng d칛r alla mellanrum i str칛ngen har bytts ut mot plustecken. Den andra metoden `getIMDbID()` tar **href** som parameter och resturnerar sj칛lva IMDb ID:t fr친n en URL. Den extraherar allts친 **tt0411008** fr친n **http://www.imdb.com/title/tt0411008/** Metoden 칛r statisk d칛rf칬r att IMDb klassen anv칛nder sig av denna metod, men det fanns inget behov av att skapa en ny instans av `queryHelper` inuti IMDb klassen. 

Slutligen har vi kvar sj칛lva IMDb klassen **IMDb.js** som best친r av ett antal metoder.

F칬rst s친 anv칛nds require f칬r att f친 in de 칬vriga npm-paket som 칛nnu inte anv칛nts, men ocks친 queryHelper klassen: 

```javascript:IMDb.js
const request = require('request');
const cheerio = require('cheerio');
const ora = require('ora');
const tab = require('table-master');
const chalk = require('chalk');
const figlet = require('figlet');

const { queryHelper } = require('./queryHelper');
```

D칛refter skapas och exporteras sj칛lva IMDb klassen med en konstruktor: 

```javascript:IMDb.js
exports.IMDb = class {

  /**
   * Creates an instance of IMDb.
   * @param {string} query - search query that has been sanitized
   * @param {string} originalQuery - The original search query  
  */
  constructor(query, originalQuery) {
    this.query = query;
    this.originalQuery = originalQuery;
    this.url = `http://www.imdb.com/search/title?title=${this.query}`;
    this.results = [];
    this.outputColor = chalk.hex('#f3ce13');
  }
}
```

Konstruktorn har tv친 parametrar och det 칛r allts친 sj칛lva s칬kstr칛ngen i dess original och i den "plussade" formen. D칛refter s칛tts `this.url` med hj칛lp av den plussade s칬kstr칛ngen som i en annan metod kommer anv칛ndas f칬r att g칬ra en reuqest och skrapa IMDb.   
`this.results` 칛r en tom array som senare ska fyllas p친 med s칬kresultat och `this.outputColor` anv칛nder npm-paketet `chalk` f칬r att spara ner IMDb:s gula f칛rg som i en annan metod kommer anv칛ndas f칬r lite f칛rgrannare utskrift i terminalen.

D칛refter inneh친ller klassen en statisk metod f칬r att visa lite ascii-text. Metoden 칛r statisk eftersom att den anropas i **index.js** innan en instans av sj칛lva IMDb klassen har skapats. Eftersom att metoden anropas innan klassen har skapats g친r den inte att anv칛nda IMDbf칛rgen som deklarerats som `this.outputColor` i klassens konstruktor. Det kan 칛nd친 vara bra att ha denna f칛rg sparad om den gula f칛rgen skulle anv칛ndas l칛ngre fram till andra saker ocks친. 

```javascript:IMDb.js
  /**
   * Static method to display IMDB header for the CLI
   * 
   */
  static displayHeader() {
    var imdbColor = chalk.hex('#f3ce13');
    console.log(imdbColor(figlet.textSync('IMDb')));
  }
```

F칬r att bygga ut `this.results` arrayen skapas ytterligare en metod p친 IMDb klassen som kan se ut p친 f칬ljande vis:

```javascript:IMDb.js
  /**
   * Push to results array
   * 
   * @param {any} title 
   * @param {any} year 
   * @param {any} imdbID 
   */
  createSearchResult(title, year, imdbID) {
    this.results.push({title, year, imdbID});
  } 
```

Denna metod anv칛nder `push` f칬r att bygga ut arrayen med ett objekt som inneh친ller titel, 친rtal och IMDb ID.

IMDb klassen inneh친ller sedan en n친got tung metod f칬r att utf칬ra sj칛lva skrapandet av IMDb och komma 친t s칬kresultaten. Metoden g친r kort och gott ut p친 att g칬ra en request till IMDb och loopa genom ett ex antal s칬kresultat och pusha dessa till `this.results`

```javascript:IMDb.js
 /**
   * Perform the scrape of imdb to gather search results
   * 
   */
  scrape() {
  	
    const spinner = ora('Searching IMDb. Please wait...').start();    
    request(this.url, (error, response, body) => {
      
      if (!error) {

        let $ = cheerio.load(body);

        $('.lister-item-header a').each((index, value) => {
          // create variables to be pushed as search result
          let title = $(value).text();
          let year = $(value).next().text().replace(/\D/g, '');
          let imdbID = this.outputColor(queryHelper.getIMDbID($(value).attr('href')));
          
          this.createSearchResult(title, year, imdbID);

          // stop the loop after 15 items
          return index < 14;
        });

        spinner.stop();        
        this.renderSearchResults();

      } else {
        spinner.stop();        
        console.log(`Program exit with error: ${error}`);
      }
    });
  }
```

N친gra nyckeldetaljer i den h칛r metoden 칛r att f칬rst och fr칛mst anv칛nds `ora` npm-paketet f칬r att starta en spinner som ger anv칛ndaren lite feedback. S칬kresultaten loopas genom med hj칛lp av `cheerio` och `$(.lister-item-header a).each()` d칛r titlar, 친rtal och id:n sparas till `this.results` med hj칛lp av metoden `this.createSearchResult()`.    

N칛r loopen har stannat efter att de femton f칬rsta s칬kresultaten har pushats till `this.results` stoppas spinnern med hj칛lp av `spinner.stop()` och en tabell med s칬kresultaten visas upp i terminalen med hj칛lp av metoden `this.renderSearchResults()`. Den metoden ser ut p친 f칬ljande vis:

```javascript:IMDb.js
  /**
   * Render either a table with search results 
   * or a message of no search results were found
   */
  renderSearchResults() {
    if (Object.keys(this.results).length === 0) {
      console.log(chalk.red(`Could not find any search results for "${this.originalQuery}". Please try again.`));
    } else {
      console.table(this.results);
    }
  }
```

Denna metod kollar f칬rst om `this.results` 칛r tom (inga s칬kresultat hittades) eller ej och antingen renderar en tabell med s칬kresultaten eller ger feedback om att inga s칬kresultat kunde hittas. H칛r anv칛nds `this.originalQuery` som allts친 exempelvis skulle motsvara `Harry Potter` och inte `Harry+Potter`.

### G칬r CLI:t k칬rbart globalt
F칬r att slippa skriva `node index.js` och hela tiden befinna sig i samma path som **index.js** finns det ett enkelt knep att g칬ra det h칛r CLI:t globalt tillg칛ngligt genom att endast skriva exempelvis `imdb` i terminalen, oberoende vilken path man har.

B칬rja med att uppgradera **package.json** med f칬ljande:

```json:package.json
  "bin": {
    "imdb": "./index.js"
  }
```
Detta binder kommandot `imdb` till att k칬ra **index.js**. L칛gg d칛refter till f칬ljande shebang h칬gst upp i **index.js**:

```javascript:index.js
#!/usr/bin/env node
const clear = require('clear');
const inquirer = require('inquirer');

//........
```
Installera d칛refter CLI:t globalt med hj칛lp av:

```bash
$ npm install -g
```

Nu 칛r CLI:t k칬rbart globalt 游꿀

Det var kort och gott all funktionalitet som finns i skrivande stund i detta Node-baserade CLI som skrapar IMDb efter s칬kresultat och IMDb ID:n. Det f칛rdiga CLI:et finns p친 [GitHub](https://github.com/danielv14/imdb-cli)